@page "/rides"
@using BikeTracking.Shared.DTOs
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="ride-list-container">
    <div class="ride-list-header">
        <h1>My Rides</h1>
        <a href="/rides/add" class="btn btn-primary">+ Record New Ride</a>
    </div>

    @if (IsLoading)
    {
        <p class="loading">Loading rides...</p>
    }
    else if (Rides?.Count > 0)
    {
        <table class="rides-table">
            <thead>
                <tr>
                    <th>Ride Name</th>
                    <th>Route</th>
                    <th>Distance</th>
                    <th>Age</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ride in Rides)
                {
                    <tr>
                        <td>
                            <a href="/rides/@ride.RideId" class="ride-link">@ride.RideName</a>
                        </td>
                        <td>@ride.StartLocation → @ride.EndLocation</td>
                        <td>@ride.Distance @ride.DistanceUnit</td>
                        <td>@ride.AgeInDays days ago</td>
                        <td>
                            <a href="/rides/@ride.RideId/edit" class="btn-small">Edit</a>
                            @if (ride.AgeInDays <= 90)
                            {
                                <button @onclick="@(() => DeleteRide(ride.RideId))" class="btn-small btn-danger">Delete</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (TotalRides > PageSize)
        {
            <div class="pagination">
                <button @onclick="@(() => CurrentPage = Math.Max(1, CurrentPage - 1))" disabled="@(CurrentPage == 1)" class="btn-small">← Previous</button>
                <span>Page @CurrentPage</span>
                <button @onclick="@(() => CurrentPage++)" disabled="@(CurrentPage * PageSize >= TotalRides)" class="btn-small">Next →</button>
            </div>
        }
    }
    else
    {
        <p class="no-rides">No rides recorded yet. <a href="/rides/add">Start recording!</a></p>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }
</div>

@code {
    private List<RideListItemResponse>? Rides;
    private int TotalRides = 0;
    private int CurrentPage = 1;
    private int PageSize = 50;
    private bool IsLoading = true;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadRides();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsLoading == false)
            await LoadRides();
    }

    private async Task LoadRides()
    {
        try
        {
            IsLoading = true;
            var response = await Http.GetFromJsonAsync<dynamic>($"/api/rides?page={CurrentPage}&pageSize={PageSize}");
            Rides = System.Text.Json.JsonSerializer.Deserialize<List<RideListItemResponse>>(
                ((System.Text.Json.JsonElement)response.GetProperty("data")).GetRawText());
            TotalRides = response.GetProperty("total").GetInt32();
            ErrorMessage = null;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load rides: {ex.Message}";
            Rides = new();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DeleteRide(Guid rideId)
    {
        if (await Confirm("Are you sure you want to delete this ride?"))
        {
            try
            {
                var response = await Http.DeleteAsync($"/api/rides/{rideId}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadRides();
                }
                else
                {
                    ErrorMessage = "Failed to delete ride";
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error deleting ride: {ex.Message}";
            }
        }
    }

    private async Task<bool> Confirm(string message)
    {
        // TODO: Replace with proper confirmation dialog
        return await Task.FromResult(true);
    }
}

<style>
    .ride-list-container {
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .ride-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .rides-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .rides-table th, .rides-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .rides-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }

    .ride-link {
        color: #FF7400;
        text-decoration: none;
        font-weight: 500;
    }

    .ride-link:hover {
        text-decoration: underline;
    }

    .btn-small {
        padding: 6px 12px;
        margin-right: 8px;
        background-color: #FF7400;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
    }

    .btn-small:hover {
        background-color: #D96200;
    }

    .btn-danger {
        background-color: #d9534f;
    }

    .btn-danger:hover {
        background-color: #c9302c;
    }

    .pagination {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .no-rides {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .loading {
        text-align: center;
        padding: 20px;
    }

    .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
</style>

